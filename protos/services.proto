syntax = "proto3";

enum ModelCategory {
  VISIONCLASSIFICATION = 0;
  TEXTGENERATION = 1;
  IMAGESEGMENTATION = 2;
  IMAGECAPTIONING = 3;
}

message GetModelsReq {
  string token = 1;
}

message ModelResponse {
  string typeString = 1;
    TextGenerationResponse text = 2;
    VisionClassificationResponse vision = 3;
    ImageSegmentationResponse segment = 4;
}

message GetModelsResp {
  message Model {
    string model_name = 1;
    ModelCategory model_category = 2;
    string uuid = 3;
  }
  repeated Model models = 1;
}

message ModelUUIDRequest {
  string model_name = 1;
  string token = 2;
}

message ModelUUIDResponse {
  string model_uuid = 1;
}

message AuthenticationRequest {
  string username = 1;
  string password = 2;
}

message AuthenticationResponse {
  bool success = 1;
  string msg = 2;
  string token = 3;
}

message RegisterTokenRequest {
  string adm_token = 1;
}

message GetTokenPermissionsRequest {
  string adm_token = 1;
  string token = 2;
}

message SetTokenPermissionsRequest {
  message ModelPermissions {
    string model_uuid = 1;
    bool remove = 2;
  }
  string adm_token = 1;
  string token = 2;
  repeated ModelPermissions models = 3;
}

message RegisterUserRequest {
  string username = 1;
  string password = 2;
  string email = 3;
}

message TextGenerationRequest {
  string input_phrase = 1;
  float temperature = 2; 

  string model_uuid = 3;
  string token = 4;
}

message TextGenerationResponse {
  repeated string generated_texts = 1;
}

message VisionClassificationRequest {
  string input_image = 1;
  uint32 num_returns = 2;

  string model_uuid = 3;
  string token = 4;
}

message VisionClassificationResponse {
  message Result {
    uint32 rank = 1;
    string category = 2;
    float proba = 3;
  }

  repeated Result results = 1;
}

message ImageSegmentationRequest {
  string input_image = 1;
  
  string model_uuid = 2;
  string token = 3;
}

message ImageSegmentationResponse {
  string output_image = 1;
}    

message ImageDownloadRequest {
  string url = 1;
}
message ImageDownloadResponse {
  string image = 1;
}

service Model {
  rpc VisionClassification(VisionClassificationRequest)
      returns (ModelResponse) {}

  rpc TextGeneration(TextGenerationRequest)
      returns (ModelResponse) {}

  rpc ImageSegmentation(ImageSegmentationRequest)
      returns (ModelResponse) {}

  rpc GetImage(ImageDownloadRequest) returns (ImageDownloadResponse) {}
  rpc ListModels(GetModelsReq) returns (GetModelsResp) {}

  rpc ModelUUID(ModelUUIDRequest) returns (ModelUUIDResponse) {}

  rpc Authenticate(AuthenticationRequest) returns (AuthenticationResponse) {}

  rpc RegisterUser(RegisterUserRequest) returns (AuthenticationResponse) {}

  rpc RegisterToken(RegisterTokenRequest) returns (AuthenticationResponse) {}

  rpc SetPermissions(SetTokenPermissionsRequest) returns (AuthenticationResponse) {}

  rpc GetPermissions(GetTokenPermissionsRequest) returns (GetModelsResp) {}
}
